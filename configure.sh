#!/bin/bash

# рд╣рд░реЗ рд░рдВрдЧ рдореЗрдВ рд╕рдВрджреЗрд╢ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд╝рдВрдХреНрд╢рди
function print_progress {
    echo -e "\e[1;32m$1\e[0m"
}

clear
print_progress "рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ... рдХреГрдкрдпрд╛ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ!"

# рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд╛рди рдХреЗ рдЖрдзрд╛рд░ рдкрд░ conf рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рддрдп рдХрд░реЗрдВ
CONF_DIR="$(pwd)/conf"

# рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ conf рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореМрдЬреВрдж рд╣реИ
if [ ! -d "$CONF_DIR" ]; then
    echo "тЪа рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА $CONF_DIR рдирд╣реАрдВ рдорд┐рд▓реА!"
    exit 1
fi

# рдЖрд╡рд╢реНрдпрдХ рдкреИрдХреЗрдЬреЛрдВ рдХреЛ рдХреНрд░рдо рдореЗрдВ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ
print_progress "рдЖрд╡рд╢реНрдпрдХ рдкреИрдХреЗрдЬ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ..."
pkg install -y php php-apache apache2 mariadb phpmyadmin toilet > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "тЭМ рдкреИрдХреЗрдЬ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдиреЗ рдореЗрдВ рд╡рд┐рдлрд▓! рдХреГрдкрдпрд╛ рдЗрдВрдЯрд░рдиреЗрдЯ рдХрдиреЗрдХреНрд╢рди рдЬрд╛рдВрдЪреЗрдВ рдФрд░ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред"
    exit 1
fi

print_progress "PHP рдФрд░ Apache рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реЗрдЯ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ..."
chmod +x "$CONF_DIR"
mv -f "$CONF_DIR/php" $HOME > /dev/null 2>&1

# рдпрджрд┐ рдкреБрд░рд╛рдиреА Apache рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореМрдЬреВрдж рд╣реИ рддреЛ рдЙрд╕реЗ рд╣рдЯрд╛рдПрдВ
if [ -f "$PREFIX/etc/apache2/httpd.conf" ]; then
    rm -r $PREFIX/etc/apache2/httpd.conf > /dev/null 2>&1
fi

# рдирдИ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ
mv -f "$CONF_DIR/httpd.conf" $PREFIX/etc/apache2 > /dev/null 2>&1
mv -f "$CONF_DIR/php_module.conf" $PREFIX/etc/apache2/extra > /dev/null 2>&1
chmod 600 $PREFIX/etc/apache2/httpd.conf
chmod 644 $PREFIX/etc/apache2/extra/php_module.conf

# phpMyAdmin рдХреЛ рддреИрдпрд╛рд░ рдХрд░рдирд╛
print_progress "phpMyAdmin рдХреЛ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ..."

# рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд▓рдХреНрд╖реНрдп рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореМрдЬреВрдж рд╣реЛ
mkdir -p $HOME/php/htdocs

# рдпрджрд┐ symlink рдкрд╣рд▓реЗ рд╕реЗ рдирд╣реАрдВ рд╣реИ рддреЛ phpMyAdmin рдХрд╛ symlink htdocs рдореЗрдВ рдмрдирд╛рдПрдВ
if [ ! -L "$HOME/php/htdocs/phpmyadmin" ]; then
    ln -s $PREFIX/share/phpmyadmin $HOME/php/htdocs/phpmyadmin
    print_progress "тЬЕ phpMyAdmin рдХрд╛ symlink рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ред"
else
    print_progress "тЬЕ phpMyAdmin рдХрд╛ symlink рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИред"
fi

# config.inc.php рдХреЛ conf рдлрд╝реЛрд▓реНрдбрд░ рд╕реЗ рдмрджрд▓реЗрдВ
if [ -f "$CONF_DIR/config.inc.php" ]; then
    cp -f "$CONF_DIR/config.inc.php" $HOME/php/htdocs/phpmyadmin/config.inc.php
    chmod 660 $HOME/php/htdocs/phpmyadmin/config.inc.php
    print_progress "тЬЕ phpMyAdmin рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдкрдбреЗрдЯ рдХреА рдЧрдИред"
else
    echo "тЪа config.inc.php рдлрд╛рдЗрд▓ $CONF_DIR рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓реА!"
fi

# start-server рдФрд░ stop-server рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рддреИрдпрд╛рд░ рдХрд░рдирд╛
print_progress "рд╕рд░реНрд╡рд░ рдХреЛ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ..."

if [ -f "$CONF_DIR/start-server" ]; then
    mv -f "$CONF_DIR/start-server" $PREFIX/bin/start-server
    chmod +x $PREFIX/bin/start-server
    print_progress "тЬЕ start-server рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХреА рдЧрдИред"
else
    echo "тЪа start-server рд╕реНрдХреНрд░рд┐рдкреНрдЯ $CONF_DIR рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓реА!"
fi

if [ -f "$CONF_DIR/stop-server" ]; then
    mv -f "$CONF_DIR/stop-server" $PREFIX/bin/stop-server
    chmod +x $PREFIX/bin/stop-server
    print_progress "тЬЕ stop-server рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХреА рдЧрдИред"
else
    echo "тЪа stop-server рд╕реНрдХреНрд░рд┐рдкреНрдЯ $CONF_DIR рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдирд╣реАрдВ рдорд┐рд▓реА!"
fi

# рд╕реНрдХреНрд░реАрди рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ рдФрд░ рдЕрдВрддрд┐рдо рд╕рдВрджреЗрд╢ рджрд┐рдЦрд╛рдПрдВ
clear
print_progress "тЬЕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреВрд░реНрдг рд╣реЛ рдЪреБрдХреА рд╣реИ!"
print_progress "рдХреГрдкрдпрд╛ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдВ:"
print_progress "- start-server рд╕рд░реНрд╡рд░ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП"
print_progress "- stop-server рд╕рд░реНрд╡рд░ рдХреЛ рдмрдВрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП"

echo ""
print_progress "ЁЯМР рд╕рд░реНрд╡рд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ: http://localhost:8080/"
print_progress "ЁЯУМ рдбреЗрдЯрд╛рдмреЗрд╕ рдЙрдкрд▓рдмреНрдз рд╣реИ: http://localhost:8080/phpmyadmin"
